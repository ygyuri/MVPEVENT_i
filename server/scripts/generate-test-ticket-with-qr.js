/* eslint-disable no-console */
/**
 * Generate test tickets with QR codes using the EXACT same algorithm as PayHero
 * 
 * This script creates test tickets that can be scanned from your organizer account.
 * The QR codes are generated using the same AES-256-CBC encryption as PayHero callback.
 * 
 * Usage:
 *   node server/scripts/generate-test-ticket-with-qr.js
 *   node server/scripts/generate-test-ticket-with-qr.js [organizer-email] [event-slug] [quantity]
 * 
 * Examples:
 *   node server/scripts/generate-test-ticket-with-qr.js
 *   node server/scripts/generate-test-ticket-with-qr.js myorganizer@example.com my-event-slug
 *   node server/scripts/generate-test-ticket-with-qr.js myorganizer@example.com my-event-slug 3
 */
require('dotenv').config({ path: require('path').join(__dirname, '..', '..', '.env') });
const mongoose = require('mongoose');
const crypto = require('crypto');
const QRCode = require('qrcode');
const { connectMongoDB } = require('../config/database');
const User = require('../models/User');
const Event = require('../models/Event');
const Order = require('../models/Order');
const Ticket = require('../models/Ticket');
const orderService = require('../services/orderService');
const ticketService = require('../services/ticketService');

async function main() {
  await connectMongoDB();
  console.log('‚úÖ Connected to MongoDB\n');

  // Get command line arguments
  const args = process.argv.slice(2);
  const organizerEmail = args[0] || 'organizer@example.com';
  const eventSlug = args[1] || null;
  const quantity = parseInt(args[2]) || 1; // Number of tickets to create

  // Find or create organizer
  let organizer = await User.findOne({ email: organizerEmail });
  if (!organizer) {
    organizer = new User({
      email: organizerEmail,
      username: organizerEmail.split('@')[0],
      role: 'organizer',
      firstName: 'Test',
      lastName: 'Organizer',
      emailVerified: true
    });
    await organizer.setPassword('password123');
    await organizer.save();
    console.log(`‚úÖ Created organizer: ${organizerEmail} / password123`);
  } else {
    console.log(`‚úÖ Found organizer: ${organizerEmail}`);
  }

  // Find or create a published event
  let event;
  if (eventSlug) {
    event = await Event.findOne({ slug: eventSlug, organizer: organizer._id });
    if (!event) {
      console.log(`‚ùå Event with slug "${eventSlug}" not found for this organizer`);
      console.log('   Creating a new event instead...\n');
      event = null;
    } else {
      console.log(`‚úÖ Found event: ${event.title} (${event.slug})`);
    }
  }

  if (!event) {
    // Find any published event by this organizer
    event = await Event.findOne({ organizer: organizer._id, status: 'published' });
    
    if (!event) {
      // Create a new test event
      event = new Event({
        organizer: organizer._id,
        title: 'Test Event for QR Scanning',
        slug: `test-qr-event-${Date.now()}`,
        description: 'Test event for QR code scanning - generated by test script',
        shortDescription: 'Test QR Event',
        category: null,
        location: { venueName: 'Test Venue', city: 'Nairobi', country: 'KE' },
        dates: { 
          startDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
          endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000 + 3 * 60 * 60 * 1000)
        },
        capacity: 100,
        pricing: { price: 1000, currency: 'KES', isFree: false },
        flags: { isFeatured: true },
        status: 'published'
      });
      await event.save();
      console.log(`‚úÖ Created test event: ${event.title} (${event.slug})`);
    } else {
      console.log(`‚úÖ Using existing event: ${event.title} (${event.slug})`);
    }
  }

  // Find or create customer
  let customer = await User.findOne({ email: 'customer@example.com' });
  if (!customer) {
    customer = new User({
      email: 'customer@example.com',
      username: 'customer',
      role: 'customer',
      firstName: 'Test',
      lastName: 'Customer',
      emailVerified: true
    });
    await customer.setPassword('password123');
    await customer.save();
    console.log('‚úÖ Created customer: customer@example.com / password123');
  } else {
    console.log('‚úÖ Found customer: customer@example.com / password123');
  }

  // Create a paid order
  const order = new Order({
    orderNumber: `TEST-${Date.now()}`,
    customer: {
      userId: customer._id,
      email: customer.email,
      firstName: customer.firstName,
      lastName: customer.lastName,
      phone: '+254700000000'
    },
    customerInfo: {
      userId: customer._id,
      email: customer.email,
      firstName: customer.firstName,
      lastName: customer.lastName,
      phone: '+254700000000'
    },
    items: [
      {
        eventId: event._id,
        eventTitle: event.title,
        ticketType: 'General Admission',
        quantity: quantity,
        unitPrice: 1000,
        subtotal: 1000 * quantity
      }
    ],
    pricing: { 
      subtotal: 1000 * quantity, 
      serviceFee: orderService.calculateServiceFee(1000 * quantity), 
      total: (1000 * quantity) + orderService.calculateServiceFee(1000 * quantity), 
      currency: 'KES' 
    },
    status: 'paid',
    paymentStatus: 'completed',
    payment: { 
      status: 'completed', 
      method: 'payhero', 
      paidAt: new Date(),
      mpesaReceiptNumber: `TEST-${Date.now()}`,
      paymentProvider: 'payhero',
      paymentReference: `TEST-${Date.now()}`
    }
  });
  await order.save();
  console.log('‚úÖ Created order:', order.orderNumber);

  // Generate tickets
  const tickets = await orderService.createTickets(order);
  console.log(`‚úÖ Created ${tickets.length} ticket(s)\n`);

  // Generate QR codes using ticketService (same as wallet displays)
  // This generates the new format (E1.xxx) that the wallet shows
  const ticketService = require('../services/ticketService');
  
  for (const ticket of tickets) {
    // Use ticketService.issueQr() to generate QR in the format wallet displays
    const qrData = await ticketService.issueQr(ticket._id, { rotate: false });
    
    // Reload ticket to get updated QR data
    await ticket.populate('eventId');
    const updatedTicket = await Ticket.findById(ticket._id);
    
    // Set metadata validFrom and validUntil for scanning validation
    // Make event dates scannable NOW (set to past/current for testing)
    const now = new Date();
    const validFrom = new Date(now.getTime() - 1 * 60 * 60 * 1000); // 1 hour ago (scannable now)
    const validUntil = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // 7 days from now
    
    updatedTicket.metadata = updatedTicket.metadata || {};
    updatedTicket.metadata.validFrom = validFrom;
    updatedTicket.metadata.validUntil = validUntil;
    
    // Also update the event dates to be scannable (if event exists)
    if (event && event.dates) {
      event.dates.startDate = validFrom;
      event.dates.endDate = new Date(now.getTime() + 3 * 60 * 60 * 1000); // 3 hours from now
      await event.save();
      console.log(`   ‚úÖ Updated event dates to be scannable`);
    }

    await updatedTicket.save();
    
    console.log(`‚úÖ QR code generated for ticket: ${updatedTicket.ticketNumber}`);
    console.log(`   Ticket ID: ${updatedTicket._id}`);
    console.log(`   QR Code (new format): ${qrData.qr.substring(0, 50)}...`);
    console.log(`   Valid from: ${validFrom.toISOString()}`);
    console.log(`   Valid until: ${validUntil.toISOString()}`);
  }

  console.log('\nüéâ Test tickets with QR codes created successfully!');
  console.log(`\nüìä Summary:`);
  console.log(`   - Event: ${event.title}`);
  console.log(`   - Organizer: ${organizerEmail}`);
  console.log(`   - Customer: ${customer.email}`);
  console.log(`   - Tickets created: ${tickets.length}`);
  console.log(`   - Order: ${order.orderNumber}`);
  
  console.log('\nüì± To test scanning on your phone:');
  console.log('   1. Make sure your server is running (docker compose up)');
  console.log('   2. Get your Mac IP: ./get-local-ip.sh');
  console.log('   3. On your phone browser, go to: http://YOUR_IP:3001/scanner');
  console.log('      (Replace YOUR_IP with your Mac\'s IP address)');
  console.log(`   4. Log in as organizer: ${organizerEmail} / password123`);
  console.log('   5. Scan the QR code from one of the test tickets');
  console.log('\nüí° Where to find QR codes to scan:');
  console.log(`   - Customer wallet: http://YOUR_IP:3001/wallet`);
  console.log(`   - Log in as: ${customer.email} / password123`);
  console.log('   - The QR codes are displayed in the ticket cards');
  console.log('   - You can also copy the QR code text and paste it in the scanner');
  
  console.log('\nüîë Login Credentials:');
  console.log(`   Organizer: ${organizerEmail} / password123`);
  console.log(`   Customer: ${customer.email} / password123`);
  
  console.log('\nüìã Ticket Details:');
  tickets.forEach((ticket, index) => {
    console.log(`\n   Ticket ${index + 1}:`);
    console.log(`   - Ticket Number: ${ticket.ticketNumber}`);
    console.log(`   - Ticket ID: ${ticket._id}`);
    console.log(`   - QR Code (first 50 chars): ${ticket.qrCode.substring(0, 50)}...`);
    console.log(`   - Status: ${ticket.status}`);
  });
  
  console.log('\n‚úÖ All tickets are ready to scan!');
  console.log('   The QR codes use the EXACT same algorithm as PayHero payment callbacks.');

  await mongoose.disconnect();
  process.exit(0);
}

main().catch(async (err) => {
  console.error('‚ùå Error:', err);
  try { await mongoose.disconnect(); } catch (_) {}
  process.exit(1);
});

